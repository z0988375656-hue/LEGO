<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚é«˜çµ„è£æŒ‘æˆ°</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        /* ç‰¹åˆ¥ç‚ºæ¨‚é«˜ä¸»é¡ŒåŠ å…¥æ›´å…·éŠæˆ²æ„Ÿçš„é¡è‰²å’Œæ¨£å¼ */
        :root {
            --lego-yellow: #FFCB05;
            --lego-red: #D71A21;
            --lego-blue: #0055BF;
            --lego-green: #00774D;
        }
        body { font-family: 'Inter', sans-serif; }

        .lego-bg {
            background-color: #f7f7f7;
            background-image: repeating-linear-gradient(45deg, #e9e9e9 0, #e9e9e9 1px, #f7f7f7 0, #f7f7f7 50%);
            background-size: 8px 8px;
        }
        .lego-title {
            color: var(--lego-red);
            text-shadow: 2px 2px 0 var(--lego-yellow);
        }
        .step-button {
            transition: all 0.15s ease-in-out;
            background-color: var(--lego-blue);
            box-shadow: 0 4px 0 var(--lego-red);
        }
        .step-button:hover {
            background-color: #0066d9;
            box-shadow: 0 6px 0 var(--lego-red);
            transform: translateY(-2px);
        }
        .step-button:active {
            box-shadow: 0 2px 0 var(--lego-red);
            transform: translateY(2px);
        }
    </style>
</head>
<body class="lego-bg min-h-screen flex flex-col items-center p-4">

    <!-- éŠæˆ²å®¹å™¨ -->
    <div id="game-container" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-10 mt-6 border-4 border-gray-300">
        <h1 class="text-4xl font-extrabold lego-title mb-4 text-center">
            ğŸ§± æ¨‚é«˜çµ„è£æŒ‘æˆ° ğŸš€
        </h1>
        <p class="text-sm text-gray-500 mb-6 text-center">æŒ‰ç…§æ­£ç¢ºçš„çµ„è£é †åºï¼Œç²å¾—æ¨‚é«˜é‡‘å¹£ï¼</p>

        <!-- éŠæˆ²è³‡è¨Šé¢æ¿ -->
        <div class="flex justify-between items-center mb-6 p-4 bg-gray-100 rounded-xl shadow-inner border-t-2 border-gray-300">
            <div class="text-lg font-semibold text-gray-700">
                <span id="current-question-display">ç¬¬ 1 é¡Œ</span> / 5 é¡Œ
            </div>
            <div class="text-2xl font-bold text-yellow-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M10 2a8 8 0 00-7.07 11.45L10 20l7.07-6.55A8 8 0 0010 2zm0 14a6 6 0 110-12 6 6 0 010 12zm0-9a1 1 0 00-1 1v4a1 1 0 102 0v-4a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                é‡‘å¹£ï¼š<span id="coin-display">0</span>
            </div>
        </div>

        <!-- éŠæˆ²ä¸»é«”å€åŸŸ -->
        <div id="game-area">
            <div class="text-center mb-6">
                <p class="text-xl text-gray-700 font-medium">è«‹æŒ‰ç…§æ­£ç¢ºé †åºçµ„è£ï¼š</p>
                <p id="target-number-display" class="text-5xl font-black mb-4 text-green-600"></p>
                <p id="target-word-hint" class="text-lg font-bold text-gray-600 bg-gray-100 py-1 px-3 rounded-full inline-block shadow-md"></p>
            </div>

            <!-- ç­”æ¡ˆæ”¾ç½®å€ (Answer Slots - æ­¥é©Ÿé †åº) -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-800 mb-2 text-center">çµ„è£é †åº (é»æ“Šæ­¥é©ŸæŒ‰éˆ•å¡«å…¥):</h3>
                <div id="answer-slots-container" class="flex flex-col space-y-2 p-4 bg-gray-50 rounded-lg border border-dashed border-gray-400 min-h-[10rem]">
                    <!-- å‹•æ…‹ç”Ÿæˆç­”æ¡ˆæ§½ -->
                    <p class="text-center text-gray-500 italic">é»æ“Šä¸‹æ–¹æ­¥é©ŸæŒ‰éˆ•é–‹å§‹çµ„è£...</p>
                </div>
            </div>

            <!-- æ­¥é©Ÿæç¤ºå€ (Scrambled Steps) - é€™æ˜¯é¸é …çš„ä½ç½® -->
            <div class="mt-8">
                <h3 class="text-lg font-bold text-gray-800 mb-2 text-center">å¯é¸æ­¥é©Ÿ (é»æ“Šä»¥é¸æ“‡):</h3>
                <!-- ä½¿ç”¨ grid è®“é¸é …åœ¨æ‰‹æ©Ÿä¸Šåˆ†å…©åˆ—é¡¯ç¤ºï¼Œæ›´å®¹æ˜“é»æ“Š -->
                <div id="letter-hints-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 p-4 bg-yellow-100 rounded-lg shadow-lg border-2 border-yellow-400 min-h-[5rem]">
                    <!-- å‹•æ…‹ç”Ÿæˆæ­¥é©ŸæŒ‰éˆ• -->
                    <p class="col-span-full text-center text-gray-600 font-semibold" id="loading-message">æ­¥é©Ÿè¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- å‹•ä½œæŒ‰éˆ• -->
            <div class="flex justify-center space-x-4 mt-8">
                <button id="undo-button" class="px-6 py-3 text-lg font-bold rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-lg" onclick="undoStep()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8m-12 7V4" />
                    </svg>
                    å¾©åŸä¸Šä¸€æ­¥
                </button>
                <button id="check-button" class="px-8 py-3 text-xl font-bold rounded-full bg-green-500 text-white hover:bg-green-600 transition duration-150 shadow-lg" onclick="checkAnswer()">
                    æª¢æŸ¥çµ„è£
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ’è¡Œæ¦œé¡¯ç¤ºå€ (æ–°å¢) -->
    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-6 md:p-10 mt-6 border-4 border-gray-300">
        <h2 class="text-3xl font-extrabold text-blue-600 mb-4 text-center">ğŸ† æ¨‚é«˜é«˜æ‰‹æ¦œ ğŸ†</h2>

        <!-- è¨­å®š ID å€åŸŸ -->
        <div id="username-setup" class="mb-6 p-4 bg-purple-100 rounded-lg border border-purple-300">
            <h3 class="text-lg font-bold text-purple-700 mb-2">è¨­å®šæ‚¨çš„ç©å®¶ IDï¼š</h3>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <input type="text" id="username-input" maxlength="16" placeholder="è¼¸å…¥æ‚¨å–œæ­¡çš„ ID (æœ€å¤š 16 å­—)" class="flex-grow p-2 rounded-lg border border-gray-300 focus:ring-purple-500 focus:border-purple-500">
                <button id="save-username-button" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150" onclick="saveDisplayName()">
                    å„²å­˜ ID
                </button>
            </div>
            <p id="username-message" class="text-sm mt-2 text-purple-600"></p>
        </div>
        <!-- çµæŸæ–°å¢ï¼šè¨­å®š ID å€åŸŸ -->

        <div id="leaderboard-list" class="space-y-2">
            <p class="text-center text-gray-500 italic">æ­£åœ¨è¼‰å…¥æ’è¡Œæ¦œ...</p>
        </div>
        <div id="user-id-display" class="mt-4 text-xs text-gray-400 text-center"></div>
    </div>
    <!-- çµæŸæ–°å¢ -->

    <!-- çµæœ/è¨Šæ¯æç¤ºå€ (Custom Modal) -->
    <div id="result-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" onclick="closeModal()">
        <div class="bg-white rounded-xl p-8 max-w-sm w-full text-center shadow-2xl transform transition-all duration-300 scale-100" onclick="event.stopPropagation()">
            <div id="modal-icon" class="text-5xl mb-4"></div>
            <h3 id="modal-title" class="text-2xl font-bold mb-3"></h3>
            <p id="modal-message" class="text-lg text-gray-600 mb-6"></p>
            <button id="modal-button" class="px-6 py-2 font-semibold rounded-full bg-blue-600 text-white hover:bg-blue-700 transition duration-150" onclick="nextQuestion()">
                ç¹¼çºŒä¸‹ä¸€é¡Œ
            </button>
        </div>
    </div>

    <!-- éŠæˆ²çµæŸç•«é¢ (Final Score Modal) -->
    <div id="finish-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-10 max-w-md w-full text-center shadow-2xl transform transition-all duration-300 scale-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-yellow-500 mx-auto mb-4 animate-bounce" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 2a8 8 0 00-7.23 4.542.5.5 0 00.5.86c.395-.145.82-.224 1.27-.224h.005c2.617 0 4.35 1.954 4.35 4.977v.003c0 1.05.15 2.067.436 2.977h-3.47c-.552 0-1 .448-1 1s.448 1 1 1h8c.552 0 1-.448 1-1s-.448-1-1-1h-3.472c.287-.91.438-1.927.438-2.977v-.003c0-3.023 1.733-4.977 4.35-4.977h.004c.45 0 .875.08 1.27.225a.5.5 0 00.5-.86A8 8 0 0010 2z" />
            </svg>
            <h3 class="text-3xl font-extrabold text-green-600 mb-4">æ­å–œï¼æ‰€æœ‰æŒ‘æˆ°å®Œæˆï¼</h3>
            <p class="text-xl text-gray-700 mb-6">æ‚¨ç¸½å…±ç²å¾—äº†ï¼š</p>
            <p id="final-coin-display" class="text-6xl font-black text-red-600 mb-8">0 é‡‘å¹£</p>
            <button class="px-8 py-3 font-semibold rounded-full bg-pink-500 text-white hover:bg-pink-600 transition duration-150 shadow-lg" onclick="location.reload()">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

<script type="module">
    // è¼‰å…¥ Firebase æ¨¡çµ„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, query, collection, onSnapshot, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase ç›¸é—œå…¨åŸŸè®Šæ•¸ ---
    let app, db, auth;
    let userId = '';
    let displayName = ''; // å„²å­˜ä½¿ç”¨è€…è¨­å®šçš„ ID
    let isAuthReady = false;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    // ----------------------------

    // å®šç¾©æ¨‚é«˜çµ„è£æŒ‘æˆ°çš„æ­¥é©Ÿ
    const LEGO_CHALLENGES = [
        { 
            target: "ç°¡å–®æ–¹å¡Š (Cube)",
            hint: "çµ„è£ä¸€å€‹ç©©å›ºçš„å››æ–¹å½¢ç©æœ¨",
            // å„²å­˜æ­¥é©Ÿçš„ç°¡çŸ­ä»£ç¢¼ (ç”¨æ–¼æª¢æŸ¥)
            steps: ["S1", "S2"], 
            // é¡¯ç¤ºçµ¦ä½¿ç”¨è€…çš„æ­¥é©Ÿåç¨±
            stepLabels: ["åº•å±¤æ”¾ç½® 2x4 ç´…è‰²ç©æœ¨", "ä¸Šæ–¹ç–Šæ”¾ 2x4 ç´…è‰²ç©æœ¨"]
        },
        { 
            target: "è¿·ä½ è³½è»Š (Mini Car)",
            hint: "çµ„è£ä¸€å°ç°¡æ˜“çš„è¼ªå¼è³½è»Š",
            steps: ["S1", "S2", "S3"], 
            stepLabels: ["å®‰è£è¼ªèƒ", "æ”¾ç½®åº•ç›¤å¹³å°", "å®‰è£æ–¹å‘ç›¤"]
        },
        { 
            target: "æ¨‚é«˜èŠ±æœµ (Flower)",
            hint: "çµ„è£ä¸€æœµå¸¶æœ‰èŠ±ç“£çš„ç©æœ¨èŠ±",
            steps: ["S1", "S2", "S3"], 
            stepLabels: ["æ”¾ç½®ç¶ è‰²èŠ±è–", "é€£æ¥é»ƒè‰²èŠ±è•Š", "å®‰è£ç´…è‰²èŠ±ç“£"]
        },
        { 
            target: "å°å‹ç­æœ›å¡” (Tower)",
            hint: "çµ„è£ä¸€åº§é ‚éƒ¨å¸¶æœ‰å±‹é ‚çš„å¡”",
            steps: ["S1", "S2", "S3"], 
            stepLabels: ["æ”¾ç½® 8x8 ç¶ è‰²åº•æ¿", "å †ç–Š 4x4 è—è‰²æ–¹å¡Š", "å®‰è£åœ“éŒå½¢å±‹é ‚"]
        },
        { 
            target: "æ©Ÿå™¨äººé ­éƒ¨ (Robot Head)",
            hint: "çµ„è£ä¸€å€‹å¸¶æœ‰å¤©ç·šçš„é ­éƒ¨",
            steps: ["S1", "S2", "S3"], 
            stepLabels: ["çµ„è£ä¸»è¦é ­éƒ¨æ–¹å¡Š", "é€£æ¥å¤©ç·š", "å®‰è£è—è‰²çœ¼ç›ç“·ç£š"]
        },
    ];

    // éŠæˆ²ç‹€æ…‹
    let gameState = {
        currentQuestionIndex: 0,
        coins: 0,
        userAnswerSteps: [], // ä½¿ç”¨è€…å·²é¸çš„æ­¥é©Ÿä»£ç¢¼ (ä¾‹å¦‚: ["S1", "S3"])
        availableSteps: [],    // æç¤ºå€å‰©é¤˜çš„æ­¥é©Ÿ ({code: "S1", label: "..."})
        currentQuestionData: null,
    };

    // DOM å…ƒç´ åƒè€ƒ (åœ¨ DOMContentLoaded å¾Œåˆå§‹åŒ–)
    var D = {}; 

    /**
     * åˆå§‹åŒ– DOM å…ƒç´ åƒè€ƒã€‚
     */
    function initializeDomReferences() {
        D = {
            questionDisplay: document.getElementById('current-question-display'),
            coinDisplay: document.getElementById('coin-display'),
            targetNumberDisplay: document.getElementById('target-number-display'),
            targetWordHint: document.getElementById('target-word-hint'),
            answerSlotsContainer: document.getElementById('answer-slots-container'),
            letterHintsContainer: document.getElementById('letter-hints-container'),
            undoButton: document.getElementById('undo-button'),
            checkButton: document.getElementById('check-button'),
            resultModal: document.getElementById('result-modal'),
            finishModal: document.getElementById('finish-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalIcon: document.getElementById('modal-icon'),
            modalButton: document.getElementById('modal-button'),
            finalCoinDisplay: document.getElementById('final-coin-display'),
            loadingMessage: document.getElementById('loading-message'),
            // æ’è¡Œæ¦œå…ƒç´ 
            leaderboardList: document.getElementById('leaderboard-list'),
            userIdDisplay: document.getElementById('user-id-display'),
            // æ–°å¢çš„ ID è¨­å®šå…ƒç´ 
            usernameInput: document.getElementById('username-input'),
            saveUsernameButton: document.getElementById('save-username-button'),
            usernameMessage: document.getElementById('username-message'),
        };
        // æª¢æŸ¥é—œéµå…ƒç´ æ˜¯å¦è¼‰å…¥æˆåŠŸ
        if (!D.letterHintsContainer) {
            console.error("Critical DOM elements not found. Cannot start game.");
            return false;
        }
        return true;
    }

    /**
     * è¼”åŠ©å‡½æ•¸ï¼šFisher-Yates æ´—ç‰Œç®—æ³•
     */
    function shuffleArray(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]
            ];
        }
        return array;
    }

    /**
     * å•Ÿå‹•æ–°ä¸€è¼ªçš„å•ç­”ã€‚
     */
    function loadQuestion() {
        const index = gameState.currentQuestionIndex;
        if (index >= LEGO_CHALLENGES.length) {
            showFinishModal();
            return;
        }

        gameState.currentQuestionData = LEGO_CHALLENGES[index];
        // åˆå§‹åŒ–ç­”æ¡ˆæ§½ç‚º null
        gameState.userAnswerSteps = Array(gameState.currentQuestionData.steps.length).fill(null);

        // æº–å‚™æç¤ºæ­¥é©Ÿï¼ŒåŒ…å«ä»£ç¢¼å’Œæ¨™ç±¤
        gameState.availableSteps = gameState.currentQuestionData.steps.map((code, i) => ({ 
            code: code, 
            label: gameState.currentQuestionData.stepLabels[i],
            originalIndex: i // ç”¨æ–¼è­˜åˆ¥æ­¥é©Ÿ
        }));
        shuffleArray(gameState.availableSteps);

        // æ›´æ–°ä»‹é¢
        D.questionDisplay.textContent = `ç¬¬ ${index + 1} é¡Œ`;
        D.targetNumberDisplay.textContent = gameState.currentQuestionData.target;
        D.targetWordHint.textContent = `æç¤ºï¼š${gameState.currentQuestionData.hint}`;

        renderAnswerSlots();
        renderStepHints();
        updateButtonState();
    }

    /**
     * æ¸²æŸ“ç­”æ¡ˆæ”¾ç½®å€ (ç©ºæ§½)ã€‚
     */
    function renderAnswerSlots() {
        D.answerSlotsContainer.innerHTML = '';
        if (gameState.userAnswerSteps.length === 0) {
             D.answerSlotsContainer.innerHTML = '<p class="text-center text-gray-500 italic">é»æ“Šä¸‹æ–¹æ­¥é©ŸæŒ‰éˆ•é–‹å§‹çµ„è£...</p>';
        } else {
            gameState.userAnswerSteps.forEach((step, index) => {
                const slot = document.createElement('button');
                slot.className = `w-full p-3 font-semibold text-lg text-left rounded-lg transition duration-100 flex items-center shadow-md ${
                    step !== null 
                        ? 'bg-blue-200 text-blue-800 hover:bg-blue-300'
                        : 'bg-gray-100 border-2 border-dashed border-gray-400 text-gray-500'
                }`;
                slot.innerHTML = step !== null 
                    ? `<span class="font-bold mr-3 text-xl text-blue-600">${index + 1}.</span> ${step.label}`
                    : `<span class="font-bold mr-3 text-xl text-gray-500">${index + 1}.</span> é»æ“Šæ­¥é©ŸæŒ‰éˆ•`;
                
                // é»æ“Šç­”æ¡ˆæ§½å¾©åŸè©²æ­¥é©Ÿ
                if (step !== null) {
                    slot.onclick = () => undoStep(index); 
                }
                D.answerSlotsContainer.appendChild(slot);
            });
        }
    }

    /**
     * æ¸²æŸ“æ­¥é©Ÿæç¤ºæŒ‰éˆ•ã€‚
     */
    function renderStepHints() {
        D.letterHintsContainer.innerHTML = '';
        let buttonCount = 0;
        gameState.availableSteps.forEach((item, index) => {
            // åªæœ‰ç•¶ item ä¸æ˜¯ 'null' æ™‚æ‰æ¸²æŸ“
            if (item && item.code) {
                buttonCount++;
                const button = document.createElement('button');
                button.className = 'step-button text-sm md:text-base font-bold text-white px-4 py-3 rounded-xl transform active:bg-blue-700 w-full whitespace-nowrap overflow-hidden text-ellipsis';
                button.textContent = item.label;
                // ä½¿ç”¨ dataset å„²å­˜æç¤ºæ­¥é©Ÿåœ¨ availableSteps ä¸­çš„ç´¢å¼•
                button.dataset.index = index;
                button.onclick = () => selectStep(index);
                D.letterHintsContainer.appendChild(button);
            }
        });

        // å¦‚æœæ²’æœ‰æŒ‰éˆ•ï¼Œé¡¯ç¤ºè¼‰å…¥/ç©ºè¨Šæ¯
        if (buttonCount === 0) {
            D.letterHintsContainer.innerHTML = '<p class="col-span-full text-center text-gray-600 font-semibold">æ‰€æœ‰æ­¥é©Ÿå·²é¸å–ï¼Œè«‹æª¢æŸ¥çµ„è£ï¼</p>';
        }
    }

    /**
     * å¾æç¤ºå€é¸æ“‡ä¸€å€‹æ­¥é©Ÿæ”¾å…¥ç­”æ¡ˆæ§½ã€‚
     * @param {number} hintIndex æç¤ºæ­¥é©Ÿåœ¨ availableSteps é™£åˆ—ä¸­çš„ç´¢å¼•
     */
    function selectStep(hintIndex) {
        // æ‰¾åˆ°ç¬¬ä¸€å€‹ç©ºçš„ç­”æ¡ˆæ§½
        const emptySlotIndex = gameState.userAnswerSteps.findIndex(s => s === null);

        if (emptySlotIndex !== -1) {
            const selectedItem = gameState.availableSteps[hintIndex];

            // 1. å°‡æ­¥é©Ÿæ”¾å…¥ç­”æ¡ˆæ§½ (å„²å­˜æ•´å€‹ç‰©ä»¶)
            gameState.userAnswerSteps[emptySlotIndex] = selectedItem;

            // 2. å¾ availableSteps ä¸­ç§»é™¤ï¼ˆä½¿ç”¨ null æ¨™è¨˜ï¼‰
            gameState.availableSteps[hintIndex] = null; 

            renderAnswerSlots();
            renderStepHints();
            updateButtonState();
        }
    }

    /**
     * å¾©åŸä¸Šä¸€å€‹æ“ä½œ (æˆ–é»æ“Šç­”æ¡ˆæ§½å¾©åŸæŒ‡å®šæ­¥é©Ÿ)ã€‚
     * @param {number} [slotIndex] å¦‚æœæä¾›ï¼Œå‰‡å¾©åŸè©²ç­”æ¡ˆæ§½ä¸­çš„æ­¥é©Ÿã€‚
     */
    function undoStep(slotIndex = -1) {
        let indexToUndo = slotIndex;

        if (indexToUndo === -1) {
            // å¦‚æœæ²’æœ‰æŒ‡å®š slotIndexï¼Œå‰‡å¾©åŸæœ€å¾Œä¸€å€‹å·²å¡«å…¥çš„æ­¥é©Ÿ
            for (let i = gameState.userAnswerSteps.length - 1; i >= 0; i--) {
                if (gameState.userAnswerSteps[i] !== null) {
                    indexToUndo = i;
                    break;
                }
            }
        }

        if (indexToUndo !== -1 && gameState.userAnswerSteps[indexToUndo] !== null) {
            const stepToMoveBack = gameState.userAnswerSteps[indexToUndo];

            // 1. æ‰¾åˆ° availableSteps ä¸­ç¬¬ä¸€å€‹ç‚º null çš„ä½ç½® (å³è¢«ä½¿ç”¨æ‰çš„æç¤ºä½ç½®)
            // ç”±æ–¼æˆ‘å€‘åªç”¨ null ä¾†æ¨™è¨˜è¢«ç§»é™¤çš„æ­¥é©Ÿï¼Œé€™è£¡æ‰¾ç¬¬ä¸€å€‹ null
            const availableIndex = gameState.availableSteps.findIndex(item => item === null);

            if (availableIndex !== -1) {
                // 2. å°‡æ­¥é©Ÿæ”¾å› availableSteps çš„ç©ºä½
                gameState.availableSteps[availableIndex] = stepToMoveBack;

                // 3. æ¸…ç©ºç­”æ¡ˆæ§½
                gameState.userAnswerSteps[indexToUndo] = null;
            } else {
                 // å…¶å¯¦ä¸æ‡‰è©²ç™¼ç”Ÿï¼Œé™¤éæ­¥é©Ÿæ•¸é‡èˆ‡ç­”æ¡ˆæ§½æ•¸é‡ä¸åŒ¹é…ï¼Œä½†å®‰å…¨èµ·è¦‹ï¼Œå¦‚æœæ²’æœ‰ null æ§½ä½ï¼Œå°±ç›´æ¥ push
                 gameState.availableSteps.push(stepToMoveBack);
                 gameState.userAnswerSteps[indexToUndo] = null;
            }


            renderAnswerSlots();
            renderStepHints();
            updateButtonState();
        }
    }


    /**
     * æ›´æ–°æŒ‰éˆ•çš„å•Ÿç”¨/ç¦ç”¨ç‹€æ…‹ã€‚
     */
    function updateButtonState() {
        if (!D.checkButton) return; // é¿å…æœªåˆå§‹åŒ–éŒ¯èª¤

        const isFull = gameState.userAnswerSteps.every(s => s !== null);
        D.checkButton.disabled = !isFull;
        
        // æ ¹æ“šæ˜¯å¦å¡«æ»¿ä¾†åˆ‡æ›æŒ‰éˆ•é¡è‰²
        if (isFull) {
            D.checkButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            D.checkButton.classList.add('bg-green-500', 'hover:bg-green-600');
        } else {
            D.checkButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            D.checkButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
        }


        const isEmpty = gameState.userAnswerSteps.every(s => s === null);
        D.undoButton.disabled = isEmpty;

        // æ ¹æ“šæ˜¯å¦ç‚ºç©ºä¾†åˆ‡æ›å¾©åŸæŒ‰éˆ•é¡è‰²
        if (isEmpty) {
            D.undoButton.classList.remove('bg-red-500', 'hover:bg-red-600');
            D.undoButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
        } else {
            D.undoButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            D.undoButton.classList.add('bg-red-500', 'hover:bg-red-600');
        }
    }

    /**
     * æª¢æŸ¥ä½¿ç”¨è€…çš„ç­”æ¡ˆæ˜¯å¦æ­£ç¢ºã€‚
     */
    function checkAnswer() {
        // ç¦ç”¨æª¢æŸ¥æŒ‰éˆ•é˜²æ­¢å¤šæ¬¡é»æ“Š
        D.checkButton.disabled = true;

        // æå–ä½¿ç”¨è€…çµ„è£æ­¥é©Ÿçš„ä»£ç¢¼
        const userAnswerCodes = gameState.userAnswerSteps.map(step => step.code);
        const correctAnswerCodes = gameState.currentQuestionData.steps;

        let title, message, iconHtml, newCoins = 0;

        // æª¢æŸ¥é †åºæ˜¯å¦å®Œå…¨åŒ¹é…
        const isCorrect = userAnswerCodes.every((code, index) => code === correctAnswerCodes[index]);

        if (isCorrect) {
            newCoins = 100;
            gameState.coins += newCoins;
            gameState.currentQuestionIndex++; // ç­”å°æ‰çœŸæ­£é€²å…¥ä¸‹ä¸€é¡Œ

            title = "âœ“ æ­å–œï¼çµ„è£æˆåŠŸï¼";
            message = `æ‚¨å®Œå…¨æŒ‰ç…§èªªæ˜æ›¸å®Œæˆäº† ${gameState.currentQuestionData.target} çš„çµ„è£ï¼Œç²å¾— ${newCoins} æšé‡‘å¹£ï¼`;
            iconHtml = '<span class="text-green-500">ğŸ†</span>';
        } else {
            // *** é—œéµè®Šå‹•åœ¨é€™è£¡ï¼šç­”éŒ¯ç›´æ¥é€²å…¥ä¸‹ä¸€é¡Œï¼Œä¸é‡ç½®ç´¢å¼•æˆ–çµ¦äºˆæ©Ÿæœƒ ***
            newCoins = 0;
            gameState.currentQuestionIndex++; 
            
            title = "âœ— çµ„è£é †åºéŒ¯èª¤ï¼";
            message = `å¾ˆå¯æƒœï¼æ­£ç¢ºçš„çµ„è£æ­¥é©Ÿæ‡‰è©²æ˜¯ï¼š<br>1. ${gameState.currentQuestionData.stepLabels.join('<br>2. ')}ã€‚<br><br>è«‹é»æ“Šã€Œç¹¼çºŒä¸‹ä¸€é¡Œã€å‰å¾€ä¸‹ä¸€å€‹æŒ‘æˆ°ã€‚`;
            iconHtml = '<span class="text-red-500">ğŸ§±</span>';
            // ç­”éŒ¯å¾Œä¸åŠ é‡‘å¹£
        }

        // æ›´æ–°ä»‹é¢é‡‘å¹£é¡¯ç¤º
        D.coinDisplay.textContent = gameState.coins;

        // é¡¯ç¤ºçµæœ Modal
        D.modalTitle.textContent = title;
        D.modalMessage.innerHTML = message; // ä½¿ç”¨ innerHTML å…è¨±æ›è¡Œ
        D.modalIcon.innerHTML = iconHtml;
        D.resultModal.classList.remove('hidden');
    }

    /**
     * é—œé–‰çµæœ Modalã€‚
     */
    function closeModal() {
        D.resultModal.classList.add('hidden');
    }

    /**
     * é€²å…¥ä¸‹ä¸€é¡Œæˆ–çµæŸéŠæˆ²ã€‚
     */
    function nextQuestion() {
        closeModal();
        loadQuestion();
    }

    /**
     * å¾ç§æœ‰è³‡æ–™ä¸­è®€å–ä½¿ç”¨è€…çš„è‡ªè¨‚ IDã€‚
     * @returns {string} é¡¯ç¤ºåç¨±ã€‚
     */
    async function loadDisplayName() {
        if (!isAuthReady || !db || !userId) return `LegoMaster_${userId.substring(0, 4)}`;

        const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/metadata`);
        try {
            const docSnap = await getDoc(profileDocRef);
            if (docSnap.exists() && docSnap.data().displayName) {
                displayName = docSnap.data().displayName;
            } else {
                displayName = `LegoMaster_${userId.substring(0, 4)}`;
            }
            return displayName;
        } catch (e) {
            console.error("Error loading display name:", e);
            return `LegoMaster_${userId.substring(0, 4)}`;
        }
    }

    /**
     * å°‡ä½¿ç”¨è€…è¼¸å…¥çš„ ID å„²å­˜åˆ°ç§æœ‰è³‡æ–™ä¸­ã€‚
     */
    window.saveDisplayName = async function() {
        const inputName = D.usernameInput.value.trim();
        D.usernameMessage.textContent = 'å„²å­˜ä¸­...';
        D.usernameMessage.classList.remove('text-red-500');
        
        if (!inputName) {
            D.usernameMessage.textContent = 'ID ä¸èƒ½ç‚ºç©ºï¼';
            D.usernameMessage.classList.add('text-red-500');
            return;
        }
        if (!isAuthReady || !db || !userId) {
            D.usernameMessage.textContent = 'èªè­‰å°šæœªå®Œæˆï¼Œè«‹ç¨å€™å†è©¦ã€‚';
            D.usernameMessage.classList.add('text-red-500');
            return;
        }

        const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/metadata`);
        try {
            await setDoc(profileDocRef, { displayName: inputName }, { merge: true });
            displayName = inputName; // æ›´æ–°å…¨åŸŸè®Šæ•¸
            D.usernameInput.value = displayName; // ç¢ºä¿è¼¸å…¥æ¡†é¡¯ç¤ºæœ€æ–°çš„
            D.usernameMessage.textContent = `ç©å®¶ ID æˆåŠŸå„²å­˜ç‚ºï¼š${displayName}`;
        } catch (e) {
            console.error("Error saving display name:", e);
            D.usernameMessage.textContent = 'å„²å­˜ ID å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚';
            D.usernameMessage.classList.add('text-red-500');
        }
    }


    /**
     * å°‡æœ€çµ‚å¾—åˆ†å„²å­˜åˆ° Firestore æ’è¡Œæ¦œã€‚
     */
    async function saveScoreToLeaderboard(finalScore) {
        if (!isAuthReady || !db || !userId) {
            console.warn("Authentication not ready or DB not initialized. Score not saved.");
            return;
        }

        const leaderboardCollectionPath = `artifacts/${appId}/public/data/leaderboard`;
        const userDocRef = doc(db, leaderboardCollectionPath, userId); // ä½¿ç”¨ userId ä½œç‚ºæ–‡æª” ID

        try {
            // 1. å–å¾—ç¾æœ‰åˆ†æ•¸
            const docSnap = await getDoc(userDocRef);
            const currentScore = docSnap.exists() ? docSnap.data().score : 0;
            
            // 2. å–å¾—ç›®å‰çš„é¡¯ç¤ºåç¨±ï¼ˆç¢ºä¿ä½¿ç”¨çš„æ˜¯æœ€æ–°è¨­å®šçš„ IDï¼‰
            const currentDisplayName = await loadDisplayName();

            // 3. åªæœ‰ç•¶æ–°å¾—åˆ†é«˜æ–¼ç¾æœ‰åˆ†æ•¸æ™‚æ‰æ›´æ–°
            if (finalScore > currentScore) {
                await setDoc(userDocRef, {
                    userId: userId,
                    username: currentDisplayName, // ä½¿ç”¨è‡ªè¨‚ ID
                    score: finalScore,
                    timestamp: Date.now()
                });
                console.log("New high score saved:", finalScore);
            } else {
                console.log("Current score is not a high score. Not saved.");
            }
        } catch (e) {
            console.error("Error saving score to leaderboard: ", e);
        }
    }


    /**
     * å¾ Firestore ç²å–ä¸¦å¯¦æ™‚æ›´æ–°æ’è¡Œæ¦œã€‚
     */
    function fetchLeaderboard() {
        if (!isAuthReady || !db) return;

        const leaderboardCollectionPath = `artifacts/${appId}/public/data/leaderboard`;
        // ä¾åˆ†æ•¸é™åºæ’åˆ—ï¼Œé™åˆ¶å‰ 10 å
        const q = query(
            collection(db, leaderboardCollectionPath),
            orderBy("score", "desc"), 
            limit(10) 
        );

        // è¨­ç½®å¯¦æ™‚ç›£è½
        onSnapshot(q, (querySnapshot) => {
            const scores = [];
            querySnapshot.forEach((doc) => {
                scores.push(doc.data());
            });
            renderLeaderboard(scores);
        }, (error) => {
            console.error("Error fetching leaderboard:", error);
            D.leaderboardList.innerHTML = '<p class="text-center text-red-500 italic">è¼‰å…¥æ’è¡Œæ¦œæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</p>';
        });
    }

    /**
     * æ¸²æŸ“æ’è¡Œæ¦œåˆ° UIã€‚
     * @param {Array} scores - å¾—åˆ†ç‰©ä»¶çš„é™£åˆ—ã€‚
     */
    function renderLeaderboard(scores) {
        D.leaderboardList.innerHTML = '';
        if (scores.length === 0) {
            D.leaderboardList.innerHTML = '<p class="text-center text-gray-500 italic">ç›®å‰ç„¡åˆ†æ•¸ç´€éŒ„ï¼Œæˆç‚ºç¬¬ä¸€åå§ï¼</p>';
            return;
        }

        scores.forEach((scoreData, index) => {
            const rank = index + 1;
            const isCurrentUser = scoreData.userId === userId;
            // ç¢ºä¿æœ‰ username å­—æ®µï¼Œä¸¦åœ¨æ²’æœ‰æ™‚å›é€€åˆ° ID
            const displayUsername = scoreData.username || `LegoMaster_${scoreData.userId.substring(0, 4)}`;

            const item = document.createElement('div');
            item.className = `flex justify-between items-center p-3 rounded-lg font-semibold shadow-sm transition-all duration-300 ${
                isCurrentUser 
                    ? 'bg-yellow-200 border-2 border-yellow-500 scale-105' // çªå‡ºé¡¯ç¤ºç•¶å‰ä½¿ç”¨è€…
                    : 'bg-gray-100 hover:bg-gray-200'
            }`;

            item.innerHTML = `
                <span class="text-xl w-8 text-center ${rank <= 3 ? 'text-red-600 font-extrabold' : 'text-gray-600'}">${rank}.</span>
                <span class="flex-1 truncate text-left ml-4 ${isCurrentUser ? 'text-yellow-700 font-extrabold' : 'text-gray-800'}">${displayUsername} ${isCurrentUser ? '(æ‚¨)' : ''}</span>
                <span class="text-xl text-right font-bold text-blue-600">${scoreData.score} é‡‘å¹£</span>
            `;
            D.leaderboardList.appendChild(item);
        });
    }

    /**
     * é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢ (åŒ…å«å„²å­˜å¾—åˆ†)ã€‚
     */
    function showFinishModal() {
        document.getElementById('game-area').classList.add('hidden');
        D.finalCoinDisplay.textContent = gameState.coins;
        D.finishModal.classList.remove('hidden');
        
        // --- Save Score ---
        saveScoreToLeaderboard(gameState.coins);
        // -----------------------
    }


    /**
     * åˆå§‹åŒ– Firebase æœå‹™ä¸¦é€²è¡Œèº«ä»½é©—è­‰ã€‚
     */
    async function initializeFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            D.userIdDisplay.textContent = "ç„¡æ³•è¼‰å…¥ Firebase é…ç½®ã€‚";
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // è™•ç†èº«ä»½é©—è­‰
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            
            // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;
                if (user) {
                    userId = user.uid;
                    // èªè­‰å®Œæˆå¾Œï¼Œè¼‰å…¥ä½¿ç”¨è€…çš„è‡ªè¨‚ ID
                    const currentDisplayName = await loadDisplayName();
                    D.usernameInput.value = currentDisplayName;
                    D.usernameMessage.textContent = `ç›®å‰çš„ç©å®¶ IDï¼š${currentDisplayName}`;
                    
                    // é¡¯ç¤ºç”¨æˆ¶ ID (å¤šäººéŠæˆ²è¦æ±‚)
                    if (D.userIdDisplay) {
                         D.userIdDisplay.textContent = `ç©å®¶ ID (ç”¨æ–¼é€£ç·š)ï¼š${userId}`;
                    }
                    // èªè­‰å®Œæˆå¾Œï¼Œç«‹å³è¼‰å…¥æ’è¡Œæ¦œ
                    fetchLeaderboard();
                } else {
                    userId = '';
                    displayName = '';
                    D.userIdDisplay.textContent = "ç©å®¶ ID: åŒ¿åä½¿ç”¨è€…";
                }
            });

        } catch (error) {
            console.error("Firebase initialization or sign-in failed:", error);
            D.userIdDisplay.textContent = "Firebase é€£æ¥éŒ¯èª¤ã€‚";
        }
    }


    // éŠæˆ²é–‹å§‹ï¼šç¢ºä¿ DOM å…§å®¹è¼‰å…¥å®Œç•¢å¾Œæ‰åŸ·è¡Œè…³æœ¬
    document.addEventListener('DOMContentLoaded', () => {
        if (initializeDomReferences()) {
            initializeFirebase(); // å…ˆåˆå§‹åŒ– Firebase å’Œèªè­‰
            loadQuestion(); // å†è¼‰å…¥å•é¡Œ
        }
    });

    // ç‚ºäº†è®“å…¨åŸŸå‡½å¼èƒ½è¢« HTML å‘¼å«ï¼Œå°‡å…¶è¨­å®šç‚º window å±¬æ€§
    window.undoStep = undoStep;
    window.checkAnswer = checkAnswer;
    window.nextQuestion = nextQuestion;
    window.closeModal = closeModal;
    window.saveDisplayName = saveDisplayName;
</script>

</body>
</html>